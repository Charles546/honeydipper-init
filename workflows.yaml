---
workflows:
  ai_chat:
    steps:
      - call_function: '{{ .ctx.ai_system }}.chat'
        with:
          convID: $ctx.convID,`{{ now | date "2006-01-02T15:04:05Z07:00" }}`
      - call_workflow: notify
        with:
          blocks:
            - type: section
              text:
                text: '{{ if .ctx.busy }}busy, try again later.{{ else }}thinking... :thinking_face:{{ end }}'
                type: mrkdwn
        export:
          update_in_channel: $data.json.channel
      - until:
          - $?ctx.done
          - $?ctx.busy
        steps:
          - call_function: '{{ .ctx.ai_system }}.chatContinue'
            with:
              timeout: "30"
          - if: [ "$?ctx.content" ]
            call_workflow: notify
            with:
              notify*:
                - $ctx.update_in_channel
              blocks:
                - type: section
                  text:
                    text: '{{if eq .ctx.msgType "think" }}>{{ end }}{{ .ctx.content }}'
                    type: mrkdwn
              update: true
          - if:
              - $?ctx.content
              - '{{ empty .ctx.done }}'
            call_workflow: notify
            with:
              blocks:
                - type: section
                  text:
                    text: '... :thinking_face:'
                    type: mrkdwn
          - if:
              - '{{ empty .ctx.content }}'
              - '$?ctx.done'
            call_workflow: notify
            with:
              notify*:
                - $ctx.update_in_channel
              blocks:
                - type: section
                  text:
                    text: 'stopped :disappointed:'
                    type: mrkdwn
              update: true
