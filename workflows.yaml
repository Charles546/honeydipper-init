---
workflows:
  ai_chat:
    with:
      chat_system: slack_bot
      notify*:
        - $ctx.channel_id
      response_type: in_channel
    steps:
      - call_function: '{{ .ctx.ai_system }}.chat'
        with:
          convID: $ctx.convID,`{{ now | date "2006-01-02T15:04:05Z07:00" }}`
      - call_workflow: notify
        with:
          blocks:
            - type: section
              text:
                text: '{{ if eq .ctx.busy "true" }}busy, try again later.{{ else }}thinking... :thinking_face:{{ end }}'
                type: mrkdwn
      - until_match:
          - done: "true"
          - busy: "true"
        steps:
          - call_function: '{{ .ctx.ai_system }}.chatContinue'
          - if: [ $ctx.content ]
            call_workflow: notify
            with:
              blocks:
                - type: section
                  text:
                    text: '{{ .ctx.content }}'
                    type: mrkdwn
              update: true
          - unless_match:
              done: "true"
            call_workflow: notify
            with:
              blocks:
                - type: section
                  text:
                    text: 'thinking... :thinking_face:'
                    type: mrkdwn
