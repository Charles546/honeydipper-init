---
workflows:
  ai_chat:
    with:
      chat_system: slack_bot
      notify*:
        - $ctx.channel_id
      response_type: in_channel
    steps:
      - call_function: '{{ .ctx.ai_system }}.chat'
        with:
          convID: $ctx.convID,`{{ now | date "2006-01-02T15:04:05Z07:00" }}`
        export:
          response: '{{ eq .ctx.busy "true" | ternary "busy" .ctx.content }}'
      - call_workflow: notify
        with:
          blocks:
            - type: section
              text:
                text: '{{ .ctx.raw | toYaml }}'
                type: plain_text
            - type: section
              text:
                text: '{{ .ctx.response }} :thinking_face:'
                type: mrkdwn

      - until_match:
          - done: "true"
          - busy: "true"
        steps:
          - wait: '5s'
          - call_function: '{{ .ctx.ai_system }}.chatContinue'
            export:
              response+: $ctx.content
          - call_workflow: notify
            with:
              blocks:
                - type: section
                  text:
                    text: '{{ .ctx.raw | toYaml }}'
                    type: plain_text
                - type: section
                  text:
                    text: '{{ .ctx.response }} :thinking_face:'
                    type: mrkdwn
              update: true

      - call_workflow: notify
        with:
          blocks:
            - type: section
              text:
                text: '{{ .ctx.raw | toYaml }}'
                type: plain_text
            - type: section
              text:
                text: $ctx.response
                type: mrkdwn
          update: true
