---
workflows:
  ai/web_request:
    with:
      site: '{{ urlParse .ctx.URL | dig "host" "" }}'
    if_match:
      site:
        - www.alphavantage.co
        - api.github.com
    call_function: ai.web_request
    export:
      _output:
        payload: $?data.body
        json: $?data.json
    else:
      with: '{{ fail "only whitelisted site is allowed" }}'

  ai/get_file_from_github:
    call_function: github.getContent
    export:
      _output:
        file_content: $ctx.file_content

  ai/search_github:
    with:
      resource_path: search/{{ .ctx.search_type }}
      page_num: $ctx.page_num,"1"
    steps:
      - call_function: github.api
        with:
          method: GET
          form:
            q: $ctx.search_query
            page: $ctx.page_num
        export:
          hasMore: '{{ dig "headers" "links" (list "") .data | first | contains "rel=\"next\"" }}'
    export:
      _output: '{"search_result": {{ .data.body }}, "page_num": {{ .ctx.page_num }}, "hasMore": {{ .ctx.hasMore }} }'
